<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Real-time Market Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .chart-container {
            grid-row: span 2;
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .logger-container {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .calculations-container {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        input, button {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #3d3d3d;
            color: #ffffff;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #007acc;
        }

        button {
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #4d4d4d;
        }

        button.connect {
            background-color: #28a745;
        }

        button.connect:hover {
            background-color: #218838;
        }

        button.disconnect {
            background-color: #dc3545;
        }

        button.disconnect:hover {
            background-color: #c82333;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #dc3545;
        }

        .status-indicator.connected {
            background-color: #28a745;
        }

        #chart {
            flex: 1;
            background-color: #1e1e1e;
            border-radius: 4px;
        }

        .logger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .logger-content {
            flex: 1;
            overflow-y: auto;
            background-color: #1e1e1e;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            display: flex;
            gap: 10px;
        }

        .log-timestamp {
            color: #888;
            flex-shrink: 0;
        }

        .log-level {
            flex-shrink: 0;
            width: 50px;
            font-weight: bold;
        }

        .log-level.INFO {
            color: #17a2b8;
        }

        .log-level.ERROR {
            color: #dc3545;
        }

        .log-level.WARNING {
            color: #ffc107;
        }

        .log-message {
            flex: 1;
            color: #ffffff;
        }

        .calculations-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .calculations-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .metric-card {
            background-color: #3d3d3d;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007acc;
        }

        .metric-title {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        .current-price {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .price-positive {
            color: #28a745;
        }

        .price-negative {
            color: #dc3545;
        }

        h2 {
            color: #ffffff;
            margin-bottom: 15px;
        }

        h3 {
            color: #ccc;
            margin-bottom: 10px;
        }

        .clear-logs {
            background-color: #6c757d;
        }

        .clear-logs:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Chart Section (Left Half) -->
        <div class="chart-container">
            <div class="control-panel">
                <div class="input-group">
                    <label>Host:</label>
                    <input type="text" id="host" value="127.0.0.1" placeholder="TWS Host">
                </div>
                <div class="input-group">
                    <label>Port:</label>
                    <input type="number" id="port" value="7497" placeholder="TWS Port">
                </div>
                <button id="connectBtn" class="connect">Connect</button>
                <button id="disconnectBtn" class="disconnect" style="display: none;">Disconnect</button>

                <div class="input-group" style="margin-left: 20px;">
                    <label>Symbol:</label>
                    <input type="text" id="symbol" value="{{ symbol }}" placeholder="Symbol">
                    <button id="subscribeBtn">Subscribe</button>
                </div>

                <div class="status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>

            <div id="chart"></div>
        </div>

        <!-- Logger Section (Bottom Right) -->
        <div class="logger-container">
            <div class="logger-header">
                <h3>Logger Output</h3>
                <button id="clearLogs" class="clear-logs">Clear Logs</button>
            </div>
            <div class="logger-content" id="loggerContent">
                <div class="log-entry">
                    <span class="log-timestamp">00:00:00</span>
                    <span class="log-level INFO">INFO</span>
                    <span class="log-message">Application initialized</span>
                </div>
            </div>
        </div>

        <!-- Calculations Section (Top Right) -->
        <div class="calculations-container">
            <div class="calculations-header">
                <h3>Real-time Calculations</h3>
            </div>
            <div class="calculations-content">
                <div class="current-price" id="currentPrice">
                    <div class="metric-title">Current Price</div>
                    <div class="metric-value">$0.00</div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Data Points</div>
                    <div class="metric-value" id="dataPoints">0</div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Average Price (50pts)</div>
                    <div class="metric-value" id="avgPrice">$0.00</div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Price Change</div>
                    <div class="metric-value" id="priceChange">$0.00</div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Volatility (1min)</div>
                    <div class="metric-value" id="volatility">0.00%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();

        // Global variables
        let chartData = [];
        let isConnected = false;
        let currentSymbol = '{{ symbol }}';
        let firstPrice = null;

        // Initialize Plotly chart
        const chartLayout = {
            title: {
                text: `${currentSymbol} Real-time Price`,
                font: { color: '#ffffff' }
            },
            paper_bgcolor: '#1e1e1e',
            plot_bgcolor: '#1e1e1e',
            font: { color: '#ffffff' },
            xaxis: {
                title: 'Time',
                color: '#ffffff',
                gridcolor: '#444'
            },
            yaxis: {
                title: 'Price ($)',
                color: '#ffffff',
                gridcolor: '#444'
            },
            margin: { t: 50, b: 50, l: 60, r: 20 }
        };

        const chartConfig = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot('chart', [{
            x: [],
            y: [],
            type: 'scatter',
            mode: 'lines',
            line: { color: '#007acc', width: 2 },
            name: currentSymbol
        }], chartLayout, chartConfig);

        // Event handlers
        document.getElementById('connectBtn').addEventListener('click', connectToTWS);
        document.getElementById('disconnectBtn').addEventListener('click', disconnectFromTWS);
        document.getElementById('subscribeBtn').addEventListener('click', subscribeToSymbol);
        document.getElementById('clearLogs').addEventListener('click', clearLogs);

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('price_update', function(data) {
            updateChart(data);
            updateCalculations(data);
        });

        socket.on('log_update', function(logs) {
            updateLogger(logs);
        });

        socket.on("connection_status", function(status) {
            const data = status["status"];
            updateConnectionStatus(data === "connected");
        });

        // Functions
        function connectToTWS() {
            const host = document.getElementById('host').value;
            const port = parseInt(document.getElementById('port').value);

            fetch('/connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, port })
            })
            .then(response => response.json())
            //.then(data => {
            //    if (data.success) {
            //        updateConnectionStatus(true);
            //    } else {
            //        alert('Failed to connect to TWS');
            //    }
            //})
            .catch(error => {
                console.error('Error:', error);
                alert('Connection error');
            });
        }

        function disconnectFromTWS() {
            fetch('/disconnect', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                updateConnectionStatus(false);
                chartData = [];
                Plotly.redraw('chart');
            });
        }

        function subscribeToSymbol() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            if (!symbol) return;

            fetch('/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSymbol = data.symbol;
                    chartData = [];
                    firstPrice = null;

                    // Update chart title
                    Plotly.relayout('chart', {
                        'title.text': `${currentSymbol} Real-time Price`
                    });
                } else {
                    alert(data.error || 'Failed to subscribe to symbol');
                }
            });
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                indicator.classList.add('connected');
                statusText.textContent = 'Connected';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
            } else {
                indicator.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                connectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'none';
            }
        }

        function updateChart(data) {
            if (!data.data) return;

            const timestamps = data.data.map(d => d.timestamp);
            const prices = data.data.map(d => d.price);

            Plotly.restyle('chart', {
                x: [timestamps],
                y: [prices]
            });
        }

        function updateCalculations(data) {
            if (!data.data || data.data.length === 0) return;

            const prices = data.data.map(d => d.price);
            const currentPrice = prices[prices.length - 1];

            // Set first price for change calculation
            if (firstPrice === null) {
                firstPrice = currentPrice;
            }

            // Update current price
            const currentPriceEl = document.getElementById('currentPrice').querySelector('.metric-value');
            currentPriceEl.textContent = `$${currentPrice.toFixed(2)}`;

            // Update price change color
            const change = currentPrice - firstPrice;
            const currentPriceContainer = document.getElementById('currentPrice');
            currentPriceContainer.classList.remove('price-positive', 'price-negative');
            if (change > 0) {
                currentPriceContainer.classList.add('price-positive');
            } else if (change < 0) {
                currentPriceContainer.classList.add('price-negative');
            }

            // Update data points
            document.getElementById('dataPoints').textContent = prices.length;

            // Calculate average price (last 50 points)
            const recentPrices = prices.slice(-50);
            const avgPrice = recentPrices.reduce((sum, price) => sum + price, 0) / recentPrices.length;
            document.getElementById('avgPrice').textContent = `$${avgPrice.toFixed(2)}`;

            // Update price change
            document.getElementById('priceChange').textContent = `$${change.toFixed(2)}`;

            // Calculate simple volatility (standard deviation of last 60 points)
            if (prices.length >= 2) {
                const recentPricesVol = prices.slice(-60);
                const mean = recentPricesVol.reduce((sum, price) => sum + price, 0) / recentPricesVol.length;
                const variance = recentPricesVol.reduce((sum, price) => sum + Math.pow(price - mean, 2), 0) / recentPricesVol.length;
                const volatility = Math.sqrt(variance) / mean * 100;
                document.getElementById('volatility').textContent = `${volatility.toFixed(2)}%`;
            }
        }

        function updateLogger(logs) {
            const loggerContent = document.getElementById('loggerContent');
            loggerContent.innerHTML = '';

            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';

                logEntry.innerHTML = `
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level ${log.level}">${log.level}</span>
                    <span class="log-message">${log.message}</span>
                `;

                loggerContent.appendChild(logEntry);
            });

            // Auto-scroll to bottom
            loggerContent.scrollTop = loggerContent.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('loggerContent').innerHTML = '';
            fetch('/log/clear', {
                method: 'POST'
            });

        }

        // Check connection status on page load
        fetch('/status')
        .then(response => response.json())
        .then(data => {
            updateConnectionStatus(data.connected);
            if (data.symbol) {
                document.getElementById('symbol').value = data.symbol;
                currentSymbol = data.symbol;
            }
        });
    </script>
</body>
</html>